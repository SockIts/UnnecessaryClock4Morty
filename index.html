<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Converter and Calendar</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
    }
    .main-container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      justify-content: center;
      align-items: flex-start;
    }
    .timer-container, .calendar-container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      text-align: center;
      width: 400px;
    }
    .time-box {
      margin: 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .time-box .input-group {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      gap: 10px;
    }
    .time-box label {
      font-size: 1.2em;
      margin-bottom: 5px;
    }
    .time-box select, .time-box input[type="time"], .calendar-container input, .calendar-container select, .calendar-container button {
      padding: 5px;
      font-size: 1em;
      width: 180px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .time-display {
      font-size: 1.5em;
      margin: 10px 0;
      font-weight: bold;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    .minutes-until {
      font-size: 1.2em;
      color: #333;
    }
    .header {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
      text-align: center;
    }
    .calendar-container .input-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .calendar-container button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    .calendar-container button:hover {
      background-color: #45a049;
    }
    .event-list {
      text-align: left;
      margin-top: 20px;
      font-size: 1em;
    }
    .event-list div {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 5px 0;
    }
    .delete-button {
      background-color: #ff0000;
      color: white;
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .delete-button:hover {
      background-color: #cc0000;
    }
  </style>
</head>
<body>
  <div class="header">Minutes Countdown and Calendar for Morty</div>
  <div class="main-container">
    <div class="timer-container">
      <div class="time-box">
        <label for="current-time">Current Time:</label>
        <div id="current-time" class="time-display"></div>
      </div>
      <div class="time-box">
        <label for="target-timezone">Target Time:</label>
        <div class="input-group">
          <select id="target-timezone">
            <option value="Africa/Johannesburg">Morty (UTC+2)</option>
            <option value="America/La_Paz">Derp (UTC-4)</option>
            <option value="Europe/Moscow">John (UTC+3)</option>
            <option value="America/Chicago">AZ (Central)</option>
            <option value="America/Denver">HP (Mountain)</option>
            <option value="America/Los_Angeles" selected>Socks (PST)</option>
          </select>
          <input type="time" id="target-time-input" value="14:30">
        </div>
        <div id="target-time" class="time-display"></div>
      </div>
      <div id="minutes-until" class="minutes-until"></div>
    </div>
    <div class="calendar-container">
      <div class="time-box">
        <label for="calendar">Add Event:</label>
        <div class="input-group">
          <input type="text" id="event-name" placeholder="Event Name">
          <input type="date" id="event-date">
          <input type="time" id="event-time">
          <select id="event-timezone">
            <option value="Africa/Johannesburg">Morty (UTC+2)</option>
            <option value="America/La_Paz">Derp (UTC-4)</option>
            <option value="Europe/Moscow">John (UTC+3)</option>
            <option value="America/Chicago">AZ (Central)</option>
            <option value="America/Denver">HP (Mountain)</option>
            <option value="America/Los_Angeles" selected>Socks (PST)</option>
          </select>
          <button id="submit-event">Add Event</button>
        </div>
        <div id="event-list" class="event-list"></div>
      </div>
    </div>
  </div>

  <script>
    // Google Apps Script Web App URL
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCtI2sGfJ-mA2_MVtICmBK43I-wd8ibqz77UL4gbzt86eCInIUh7ZTJ3LFAZXmGoXe/exec';

    // Available timezones
    const timezones = [
      { id: 'Africa/Johannesburg', display: 'Morty (UTC+2)' },
      { id: 'America/La_Paz', display: 'Derp (UTC-4)' },
      { id: 'Europe/Moscow', display: 'John (UTC+3)' },
      { id: 'America/Chicago', display: 'AZ (Central)' },
      { id: 'America/Denver', display: 'HP (Mountain)' },
      { id: 'America/Los_Angeles', display: 'Socks (PST)' }
    ];

    // Function to format time in 12-hour format with AM/PM
    function formatTime(date, timezone) {
      return date.toLocaleTimeString('en-US', {
        timeZone: timezone,
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    // Function to calculate minutes until target time
    function calculateMinutesUntil(currentDate, targetDate) {
      const diffMs = targetDate - currentDate;
      const diffMins = Math.round(diffMs / 60000);
      return diffMins >= 0 ? diffMins : diffMins + 1440;
    }

    // Function to parse time input (HH:MM) to hours and minutes
    function parseTimeInput(timeString) {
      const [hours, minutes] = timeString.split(':').map(Number);
      return { hours, minutes };
    }

    // Function to update the time displays
    function updateTimes() {
      const targetTimezone = document.getElementById('target-timezone').value;
      const targetTimeInput = document.getElementById('target-time-input').value;

      // Get current time for all timezones
      const now = new Date();
      const currentTimeDisplay = timezones.map(timezone => {
        const time = formatTime(now, timezone.id);
        return `<div>${timezone.display}: ${time}</div>`;
      }).join('');
      document.getElementById('current-time').textContent = '';
      document.getElementById('current-time').innerHTML = currentTimeDisplay;

      // Parse target time input
      const { hours, minutes } = parseTimeInput(targetTimeInput);

      // Set target time in selected timezone
      const targetDate = new Date();
      targetDate.setHours(hours, minutes, 0, 0);
      const targetTime = formatTime(targetDate, targetTimezone);
      document.getElementById('target-time').textContent = targetTime;

      // Calculate minutes until target time
      const currentDateInTargetZone = new Date().toLocaleString('en-US', { timeZone: targetTimezone });
      const currentDate = new Date(currentDateInTargetZone);
      const targetDateAdjusted = new Date(currentDate);
      targetDateAdjusted.setHours(hours, minutes, 0, 0);
      if (currentDate.getHours() > hours || (currentDate.getHours() === hours && currentDate.getMinutes() > minutes)) {
        targetDateAdjusted.setDate(targetDateAdjusted.getDate() + 1);
      }
      const minutesUntil = calculateMinutesUntil(currentDate, targetDateAdjusted);
      document.getElementById('minutes-until').textContent = `${minutesUntil} minutes until target time`;
    }

    // Event handling for calendar
    async function addEvent() {
      const eventName = document.getElementById('event-name').value;
      const eventDate = document.getElementById('event-date').value;
      const eventTime = document.getElementById('event-time').value;
      const eventTimezone = document.getElementById('event-timezone').value;

      if (eventName && eventDate && eventTime && eventTimezone) {
        const timezoneDisplay = timezones.find(tz => tz.id === eventTimezone).display;
        try {
          const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=addEvent`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name: eventName,
              date: eventDate,
              time: eventTime,
              timezone: timezoneDisplay
            })
          });
          const result = await response.json();
          if (result.error) {
            console.error('Error adding event:', result.error);
            alert(`Failed to add event: ${result.error}`);
          } else {
            document.getElementById('event-name').value = '';
            document.getElementById('event-date').value = '';
            document.getElementById('event-time').value = '';
            updateEventList();
          }
        } catch (error) {
          console.error('Error adding event:', error.message, error);
          alert(`Failed to add event: ${error.message}. Check console for details.`);
        }
      } else {
        alert('Please fill in all event fields.');
      }
    }

    async function deleteEvent(id) {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=deleteEvent`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id })
        });
        const result = await response.json();
        if (result.error) {
          console.error('Error deleting event:', result.error);
          alert(`Failed to delete event: ${result.error}`);
        } else {
          updateEventList();
        }
      } catch (error) {
        console.error('Error deleting event:', error.message, error);
        alert(`Failed to delete event: ${error.message}. Check console for details.`);
      }
    }

    async function updateEventList() {
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getEvents`);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const events = await response.json();
        if (events.error) {
          throw new Error(events.error);
        }
        const eventList = document.getElementById('event-list');
        eventList.innerHTML = events.map(event => 
          `<div>${event.name} - ${event.date} at ${event.time} (${event.timezone}) 
             <button class="delete-button" onclick="deleteEvent('${event.id}')">X</button></div>`
        ).join('');
      } catch (error) {
        console.error('Error fetching events:', error.message, error);
        alert(`Failed to load events: ${error.message}. Check console for details.`);
      }
    }

    // Initialize event list on page load
    updateEventList();

    // Update times initially and every second
    updateTimes();
    setInterval(updateTimes, 1000);

    // Update times when timezone or target time changes
    document.getElementById('target-timezone').addEventListener('change', updateTimes);
    document.getElementById('target-time-input').addEventListener('change', updateTimes);

    // Add event listener for event submission
    document.getElementById('submit-event').addEventListener('click', addEvent);
  </script>
</body>
</html>
