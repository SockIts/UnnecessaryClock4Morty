<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Multi-Timezone Clock & Calendar</title>
  <style>
    :root {
      --bg: #f0f0f0;
      --card-bg: white;
      --text: #333;
      --text-light: #666;
      --text-lighter: #999;
      --border: #eee;
      --shadow: rgba(0,0,0,0.1);
      --accent: #2196f3;
      --success: #4CAF50;
      --danger: #d32f2f;
      --slider-bg: #ddd;
      --comparison-bg: #f8f9fa;
      --comparison-border: #e0e0e0;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e0e0e0;
      --text-light: #bbbbbb;
      --text-lighter: #888888;
      --border: #333;
      --shadow: rgba(0,0,0,0.4);
      --accent: #42a5f5;
      --success: #66bb6a;
      --danger: #ef5350;
      --slider-bg: #444;
      --comparison-bg: #2d2d2d;
      --comparison-border: #444;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      min-height: 100vh; 
      margin: 0; 
      background-color: var(--bg); 
      color: var(--text);
      font-size: 14px; 
      transition: background-color 0.3s, color 0.3s;
    }

    .header { 
      font-size: 1.5em; 
      font-weight: 700; 
      margin: 20px 0 10px; 
      color: var(--text); 
      text-align: center; 
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .theme-toggle {
      background: none;
      border: none;
      font-size: 1.4em;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .theme-toggle:hover {
      background: rgba(128,128,128,0.2);
    }

    .main-container {
      display: grid;
      grid-template-columns: 1fr 1.3fr 1fr;
      gap: 16px;
      width: 100%;
      max-width: 1400px;
      padding: 16px;
      box-sizing: border-box;
    }

    .panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .timer-container, 
    .slider-container, 
    .events-container, 
    .monthly-calendar-container,
    .todo-container,
    .comic-container { 
      background-color: var(--card-bg); 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 2px 8px var(--shadow); 
      box-sizing: border-box; 
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s;
    }

    /* Comic Container */
    .comic-container {
      align-items: center;
      text-align: center;
    }
    .comic-title {
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--text);
    }
    .comic-img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .comic-img:hover {
      transform: scale(1.02);
    }
    .comic-alt {
      margin-top: 10px;
      font-style: italic;
      color: var(--text-light);
      font-size: 0.9em;
    }
    .comic-loading {
      color: var(--text-light);
      font-style: italic;
    }
    .comic-new-btn {
      margin-top: 16px;
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95em;
    }
    .comic-new-btn:hover {
      background: #45a049;
    }

    /* Comic Modal */
    .comic-modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.9);
      align-items: center;
      justify-content: center;
      padding: 20px;
      box-sizing: border-box;
    }
    .comic-modal.active {
      display: flex;
    }
    .comic-modal-img {
      max-width: 90%;
      max-height: 90vh;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }
    .comic-modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: white;
      font-size: 2.5em;
      font-weight: bold;
      cursor: pointer;
      background: none;
      border: none;
    }

    /* Rest of styles unchanged */
    .current-time-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); font-size: 1.05em; }
    .current-time-item:last-child { border-bottom: none; }
    .current-time-label { font-weight: 600; color: var(--text); }
    .current-time-value { font-weight: 500; color: var(--text-light); }

    .slider-container { height: 420px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    #time-slider { width: 90%; max-width: 380px; height: 8px; border-radius: 5px; background: var(--slider-bg); outline: none; margin: 20px 0; }
    #time-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 28px; height: 28px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
    .slider-label { font-weight: 600; margin-bottom: 8px; color: var(--text); }
    .slider-time-display { font-size: 1.9em; font-weight: bold; color: var(--accent); margin: 16px 0; }
    .slider-comparison { background: var(--comparison-bg); padding: 16px; border-radius: 10px; line-height: 2; font-size: 1em; font-weight: 500; border: 1px solid var(--comparison-border); width: 90%; max-width: 380px; color: var(--text-light); }

    .add-event-toggle { background: var(--success); color: white; border: none; padding: 14px; font-size: 1em; font-weight: 600; border-radius: 10px; cursor: pointer; width: 100%; }
    .add-event-toggle:hover { background: #45a049; }
    .event-form { display: none; flex-direction: column; gap: 10px; margin: 16px 0; padding: 16px; background: var(--comparison-bg); border-radius: 10px; border: 1px solid var(--border); }
    .event-form.show { display: flex; }
    select, input[type="date"], input[type="time"], input[type="text"] { padding: 11px; font-size: 1em; width: 100%; border: 1px solid var(--border); border-radius: 8px; background: var(--card-bg); color: var(--text); }
    .event-item { background: var(--comparison-bg); border-radius: 10px; padding: 14px; margin: 12px 0; border-left: 5px solid var(--success); position: relative; }
    .event-countdown { font-weight: bold; font-size: 1.1em; color: var(--danger); margin-bottom: 8px; }
    .event-name { font-weight: 600; font-size: 1.1em; margin-bottom: 6px; color: var(--text); }
    .event-details { font-size: 0.92em; color: var(--text-light); line-height: 1.5; }
    .delete-button { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; }
    .filter-info { text-align: center; margin: 10px 0; font-weight: 600; color: var(--accent); }
    .clear-filter-btn { background: none; border: none; color: var(--accent); text-decoration: underline; cursor: pointer; font-size: 0.9em; }

    .monthly-calendar { flex: 1; display: flex; flex-direction: column; }
    .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; font-weight: 600; font-size: 1.2em; color: var(--text); }
    .cal-nav-btn { background: none; border: none; font-size: 1.5em; cursor: pointer; color: var(--text-light); }
    .cal-nav-btn:hover { color: var(--accent); }
    .cal-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-weight: 600; color: var(--text-light); margin-bottom: 8px; }
    .cal-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 8px; position: relative; font-size: 0.95em; cursor: pointer; color: var(--text); transition: background 0.2s; }
    .cal-day:hover { background: rgba(128,128,128,0.2); }
    .cal-day.other-month { color: var(--text-lighter); }
    .cal-day.today { background: var(--accent); color: white; font-weight: bold; }
    .cal-day.selected { background: var(--accent) !important; color: white; font-weight: bold; }
    .cal-day.has-events::after { content: attr(data-count); position: absolute; bottom: 4px; font-size: 0.7em; background: var(--success); color: white; width: 18px; height: 18px; border-radius: 50%; line-height: 18px; }
    .cal-day.has-events { font-weight: bold; }

    .todo-input-group { display: flex; gap: 8px; margin-bottom: 16px; }
    .todo-input { flex: 1; padding: 11px; border: 1px solid var(--border); border-radius: 8px; background: var(--card-bg); color: var(--text); }
    .todo-add-btn { background: var(--success); color: white; border: none; padding: 0 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .todo-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .todo-item:last-child { border-bottom: none; }
    .todo-checkbox { margin-right: 12px; width: 18px; height: 18px; cursor: pointer; }
    .todo-text { flex: 1; transition: opacity 0.2s; }
    .todo-text.completed { text-decoration: line-through; opacity: 0.6; color: var(--text-light); }
    .todo-delete { background: none; border: none; color: var(--danger); font-size: 1.2em; cursor: pointer; padding: 4px; }

    @media (max-width: 1200px) {
      .main-container { grid-template-columns: 1fr 1fr; }
      .left-panel { grid-column: 1 / 2; }
      .events-container { grid-column: 2 / 3; }
      .monthly-calendar-container, .todo-container { grid-column: 1 / 3; }
    }

    @media (max-width: 768px) {
      .main-container { grid-template-columns: 1fr; }
      .left-panel, .events-container, .monthly-calendar-container, .todo-container { grid-column: 1 / 2; }
      .slider-container { height: auto; }
      .header { flex-direction: column; gap: 8px; }
    }
  </style>
</head>
<body>
  <div class="header">
    Minutes Countdown & Calendar
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode">üåô</button>
  </div>

  <div class="main-container">
    <!-- LEFT: Clocks + Slider + Comic -->
    <div class="panel left-panel">
      <div class="timer-container">
        <h3 style="margin:0 0 16px;text-align:center;">Current Time (All Zones)</h3>
        <div id="current-time"></div>
      </div>
      <div class="slider-container">
        <h3 style="margin:0 0 16px;">Interactive Time Comparison</h3>
        <div class="slider-label">Drag to pick a time (30-min steps)</div>
        <input type="range" min="0" max="47" value="24" step="1" id="time-slider">
        <div class="slider-time-display" id="slider-time">12:00 PM</div>
        <div class="slider-comparison" id="slider-comparison"></div>
      </div>

      <!-- Daily Comic with New Comic Button -->
      <div class="comic-container">
        <h3 style="margin:0 0 16px;text-align:center;">Daily Comic</h3>
        <div id="comic-content">
          <p class="comic-loading">Loading comic...</p>
        </div>
        <button class="comic-new-btn" id="comic-new-btn">New Comic</button>
      </div>
    </div>

    <!-- MIDDLE: Events -->
    <div class="panel events-container">
      <h3 style="margin:0 0 16px;text-align:center;">Events</h3>
      <button class="add-event-toggle" id="toggle-form">+ Add Event</button>
      <div class="event-form" id="event-form">
        <input type="text" id="event-name" placeholder="Event Name">
        <input type="date" id="event-date">
        <input type="time" id="event-time">
        <select id="event-timezone">
          <option value="Africa/Johannesburg">Morty (UTC+2)</option>
          <option value="America/Chicago">AZ (Central)</option>
          <option value="America/Denver">HP (Mountain)</option>
          <option value="America/Los_Angeles" selected>Socks (PST)</option>
        </select>
        <button id="submit-event">Save Event</button>
        <button type="button" id="cancel-form">Cancel</button>
      </div>
      <div id="filter-info" class="filter-info" style="display:none;"></div>
      <div id="event-list" style="margin-top:20px;"></div>
    </div>

    <!-- RIGHT: Calendar + To-Do -->
    <div class="panel" style="display: flex; flex-direction: column; gap: 16px;">
      <div class="monthly-calendar-container">
        <h3 style="margin:0 0 16px;text-align:center;">Monthly Overview</h3>
        <div class="monthly-calendar">
          <div class="cal-header">
            <button class="cal-nav-btn" id="cal-prev">‚Äπ</button>
            <div id="cal-month-year"></div>
            <button class="cal-nav-btn" id="cal-next">‚Ä∫</button>
          </div>
          <div class="cal-weekdays">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="cal-days" id="cal-days"></div>
        </div>
      </div>

      <div class="todo-container">
        <h3 style="margin:0 0 16px;text-align:center;">To-Do List</h3>
        <div class="todo-input-group">
          <input type="text" id="todo-input" class="todo-input" placeholder="Add a new task...">
          <button class="todo-add-btn" id="todo-add">Add Task</button>
        </div>
        <div id="todo-list"></div>
      </div>
    </div>
  </div>

  <!-- Comic Modal Overlay -->
  <div class="comic-modal" id="comic-modal">
    <button class="comic-modal-close" id="comic-modal-close">&times;</button>
    <img class="comic-modal-img" id="comic-modal-img" src="" alt="Expanded comic">
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCTXT46OZKsskx6CwpPiVzCiH-l3jSmOqY",
      authDomain: "unnecessaryclock4morty.firebaseapp.com",
      databaseURL: "https://unnecessaryclock4morty-default-rtdb.firebaseio.com",
      projectId: "unnecessaryclock4morty",
      storageBucket: "unnecessaryclock4morty.appspot.com",
      messagingSenderId: "186405906702",
      appId: "1:186405906702:web:b83abcb3cd3e3440768f5f",
      measurementId: "G-XEWKNH3EYJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const eventsRef = ref(db, 'events');
    const todosRef = ref(db, 'todos');

    const timezones = [
      { id: 'Africa/Johannesburg', name: 'Morty (UTC+2)' },
      { id: 'America/Chicago', name: 'AZ (Central)' },
      { id: 'America/Denver', name: 'HP (Mountain)' },
      { id: 'America/Los_Angeles', name: 'Socks (PST)' }
    ];

    let events = [];
    let eventsWithKeys = {};
    let filteredDate = null;
    let todosWithKeys = {};

    // Night Mode
    const themeToggle = document.getElementById('theme-toggle');
    const currentTheme = localStorage.getItem('theme') || 'light';
    if (currentTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeToggle.textContent = '‚òÄÔ∏è';
    }
    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
        themeToggle.textContent = 'üåô';
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        themeToggle.textContent = '‚òÄÔ∏è';
      }
    });

    // Daily Comic
    async function loadRandomComic() {
      const content = document.getElementById('comic-content');
      content.innerHTML = '<p class="comic-loading">Loading new comic...</p>';

      try {
        const latestRes = await fetch('https://getxkcd.vercel.app/api/comic?num=latest');
        const latest = await latestRes.json();
        const maxNum = latest.num;

        const randomNum = Math.floor(Math.random() * maxNum) + 1;
        const res = await fetch(`https://getxkcd.vercel.app/api/comic?num=${randomNum}`);
        const comic = await res.json();

        content.innerHTML = `
          <div class="comic-title">${comic.safe_title}</div>
          <img src="${comic.img}" alt="${comic.alt}" class="comic-img" id="comic-img" title="${comic.alt}">
          <div class="comic-alt">${comic.alt}</div>
        `;

        // Re-attach click handler for modal
        document.getElementById('comic-img').addEventListener('click', () => openComicModal(comic.img, comic.alt));
      } catch (err) {
        content.innerHTML = '<p class="comic-loading">Failed to load comic üòÖ<br>Try again!</p>';
      }
    }

    // Initial load
    loadRandomComic();

    // New Comic button
    document.getElementById('comic-new-btn').addEventListener('click', loadRandomComic);

    // Comic Modal
    const modal = document.getElementById('comic-modal');
    const modalImg = document.getElementById('comic-modal-img');
    const modalClose = document.getElementById('comic-modal-close');

    function openComicModal(src, alt) {
      modalImg.src = src;
      modalImg.alt = alt;
      modal.classList.add('active');
    }

    modalClose.addEventListener('click', () => modal.classList.remove('active'));
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.classList.remove('active');
    });

    const baseDate = new Date();
    baseDate.setHours(0, 0, 0, 0);

    function getEventDate(ev) {
      if (!ev.date || !ev.time) return null;
      const [y, m, d] = ev.date.split('-').map(Number);
      const [h, min] = ev.time.split(':').map(Number);
      return new Date(y, m - 1, d, h, min);
    }

    function updateCurrentTimes() {
      const now = new Date();
      document.getElementById('current-time').innerHTML = timezones.map(tz => {
        const formatted = now.toLocaleString('en-US', {
          timeZone: tz.id,
          weekday: 'short', month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit', hour12: true
        });
        return `<div class="current-time-item">
          <span class="current-time-label">${tz.name}</span>
          <span class="current-time-value">${formatted}</span>
        </div>`;
      }).join('');
    }

    function updateSlider() {
      const step = parseInt(document.getElementById('time-slider').value) || 24;
      const totalMins = step * 30;
      const hrs = Math.floor(totalMins / 60);
      const mins = totalMins % 60;
      const ampm = hrs < 12 ? 'AM' : 'PM';
      const displayHr = hrs === 0 ? 12 : hrs > 12 ? hrs - 12 : hrs;
      document.getElementById('slider-time').textContent = `${displayHr}:${mins === 0 ? '00' : '30'} ${ampm}`;

      const selected = new Date(baseDate);
      selected.setHours(hrs, mins);

      document.getElementById('slider-comparison').innerHTML = timezones.map(tz => {
        const time = selected.toLocaleTimeString('en-US', {
          timeZone: tz.id,
          hour: 'numeric', minute: '2-digit', hour12: true
        });
        return `<strong>${tz.name}:</strong> ${time}`;
      }).join('<br>');
    }

    function renderEvents() {
      const el = document.getElementById('event-list');
      const filterInfo = document.getElementById('filter-info');

      let displayEvents = events;
      if (filteredDate) {
        displayEvents = events.filter(ev => ev.date === filteredDate);
        filterInfo.innerHTML = `Showing events for <strong>${new Date(filteredDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</strong> 
          <button class="clear-filter-btn" id="clear-filter">Clear filter</button>`;
        filterInfo.style.display = 'block';
      } else {
        filterInfo.style.display = 'none';
      }

      if (!displayEvents.length) {
        el.innerHTML = '<p style="text-align:center;color:var(--text-lighter);margin-top:20px;">No events' + (filteredDate ? ' on this day' : '') + '</p>';
        renderMonthlyCalendar();
        return;
      }

      const sortedEvents = displayEvents.slice().sort((a, b) => {
        const dateA = getEventDate(a);
        const dateB = getEventDate(b);
        if (!dateA || !dateB) return 0;
        return Math.abs(dateA - new Date()) - Math.abs(dateB - new Date());
      });

      el.innerHTML = sortedEvents.map((ev) => {
        const ed = getEventDate(ev);
        const diff = Math.round((ed - new Date()) / 60000);
        const countdown = diff > 0 ? `${diff} min until start`
          : diff < 0 ? `${-diff} min ago`
          : 'Happening NOW!';

        const all = timezones.map(tz => `<strong>${tz.name}:</strong> ${ed.toLocaleString('en-US', {
          timeZone: tz.id,
          weekday: 'long', month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit', hour12: true
        })}`).join('<br>');

        const key = Object.keys(eventsWithKeys).find(k => eventsWithKeys[k] === ev);

        return `<div class="event-item">
          <button class="delete-button" data-key="${key}">X</button>
          <div class="event-countdown">${countdown}</div>
          <div class="event-name">${ev.name}</div>
          <div class="event-details">
            Original: ${ev.date} at ${ev.time} (${ev.timezone})<br><br>
            <strong>All timezones:</strong><br>${all}
          </div>
        </div>`;
      }).join('');

      renderMonthlyCalendar();
    }

    function renderTodos() {
      const list = document.getElementById('todo-list');
      const todoArray = Object.keys(todosWithKeys).map(key => ({
        key,
        ...todosWithKeys[key]
      }));

      if (todoArray.length === 0) {
        list.innerHTML = '<p style="text-align:center;color:var(--text-lighter);">No tasks yet</p>';
        return;
      }

      list.innerHTML = todoArray.map(todo => `
        <div class="todo-item">
          <input type="checkbox" class="todo-checkbox" data-key="${todo.key}" ${todo.completed ? 'checked' : ''}>
          <span class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</span>
          <button class="todo-delete" data-key="${todo.key}">√ó</button>
        </div>
      `).join('');
    }

    let currentCalMonth = new Date();

    function renderMonthlyCalendar() {
      const daysEl = document.getElementById('cal-days');
      const headerEl = document.getElementById('cal-month-year');

      const year = currentCalMonth.getFullYear();
      const month = currentCalMonth.getMonth();

      headerEl.textContent = currentCalMonth.toLocaleString('en-US', { month: 'long', year: 'numeric' });

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - firstDay.getDay());

      const endDate = new Date(lastDay);
      endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));

      const eventCounts = {};
      events.forEach(ev => {
        if (ev.date) eventCounts[ev.date] = (eventCounts[ev.date] || 0) + 1;
      });

      let html = '';
      let current = new Date(startDate);
      while (current <= endDate) {
        const dateStr = current.toISOString().slice(0, 10);
        const isCurrentMonth = current.getMonth() === month;
        const isToday = dateStr === new Date().toISOString().slice(0, 10);
        const count = eventCounts[dateStr] || 0;
        const isSelected = dateStr === filteredDate;

        html += `<div class="cal-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''} ${count > 0 ? 'has-events' : ''} ${isSelected ? 'selected' : ''}" 
                      data-date="${dateStr}"
                      ${count > 0 ? `data-count="${count}"` : ''}>
                  ${current.getDate()}
                </div>`;
        current.setDate(current.getDate() + 1);
      }
      daysEl.innerHTML = html;
    }

    // Firebase listeners
    onValue(eventsRef, (snapshot) => {
      events = [];
      eventsWithKeys = snapshot.val() || {};
      Object.values(eventsWithKeys).forEach(ev => {
        if (ev && ev.name && ev.date && ev.time && ev.timezoneId) {
          events.push(ev);
        }
      });
      renderEvents();
    });

    onValue(todosRef, (snapshot) => {
      todosWithKeys = snapshot.val() || {};
      renderTodos();
    });

    // To-Do actions
    document.getElementById('todo-add').addEventListener('click', () => {
      const input = document.getElementById('todo-input');
      const text = input.value.trim();
      if (!text) return;
      push(todosRef, { text, completed: false });
      input.value = '';
    });

    document.getElementById('todo-input').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') document.getElementById('todo-add').click();
    });

    document.getElementById('todo-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('todo-checkbox')) {
        const key = e.target.getAttribute('data-key');
        update(ref(db, 'todos/' + key), { completed: e.target.checked });
      } else if (e.target.classList.contains('todo-delete')) {
        const key = e.target.getAttribute('data-key');
        remove(ref(db, 'todos/' + key));
      }
    });

    // Calendar
    document.getElementById('cal-prev').addEventListener('click', () => {
      currentCalMonth.setMonth(currentCalMonth.getMonth() - 1);
      renderMonthlyCalendar();
    });

    document.getElementById('cal-next').addEventListener('click', () => {
      currentCalMonth.setMonth(currentCalMonth.getMonth() + 1);
      renderMonthlyCalendar();
    });

    document.getElementById('cal-days').addEventListener('click', (e) => {
      const dayEl = e.target.closest('.cal-day');
      if (!dayEl || dayEl.classList.contains('other-month')) return;
      const dateStr = dayEl.getAttribute('data-date');
      filteredDate = (filteredDate === dateStr) ? null : dateStr;
      renderEvents();
    });

    document.getElementById('filter-info').addEventListener('click', (e) => {
      if (e.target.id === 'clear-filter') {
        filteredDate = null;
        renderEvents();
      }
    });

    // Events
    function addEvent() {
      const name = document.getElementById('event-name').value.trim();
      const date = document.getElementById('event-date').value;
      const time = document.getElementById('event-time').value;
      const tzId = document.getElementById('event-timezone').value;

      if (!name || !date || !time) {
        alert('Please fill all fields');
        return;
      }

      const tzName = timezones.find(t => t.id === tzId)?.name || tzId;

      push(eventsRef, {
        name, date, time, timezone: tzName, timezoneId: tzId
      });

      document.getElementById('event-name').value = '';
      document.getElementById('event-form').classList.remove('show');
    }

    document.getElementById('event-list').addEventListener('click', (e) => {
      if (e.target.classList.contains('delete-button')) {
        const key = e.target.getAttribute('data-key');
        if (key) remove(ref(db, 'events/' + key));
      }
    });

    document.getElementById('toggle-form').addEventListener('click', () => {
      const form = document.getElementById('event-form');
      form.classList.toggle('show');
      if (form.classList.contains('show')) {
        document.getElementById('event-date').valueAsDate = new Date();
      }
    });

    document.getElementById('cancel-form').addEventListener('click', () => {
      document.getElementById('event-form').classList.remove('show');
    });

    document.getElementById('submit-event').addEventListener('click', addEvent);
    document.getElementById('time-slider').addEventListener('input', updateSlider);

    updateSlider();
    updateCurrentTimes();
    renderEvents();
    renderTodos();
    setInterval(() => {
      updateCurrentTimes();
      renderEvents();
    }, 60000);
  </script>
</body>
</html>
